FROM node:16-alpine

WORKDIR /usr/src/nest-react/
COPY .eslintrc .
COPY .eslintignore .
COPY package.json .
COPY tsconfig.json .
COPY yarn.lock .
COPY scripts/fix-common-package-exports.sh scripts/fix-common-package-exports.sh

COPY packages/server packages/server
COPY packages/domain packages/domain
COPY packages/lib packages/lib
COPY VERSION .

# Install domain + lib + server dependencies
RUN yarn install --pure-lockfile --non-interactive

# Build common packages
RUN yarn build:common

# RUN apk add --update --no-cache openssl1.1-compat

# Move to the server app
WORKDIR /usr/src/nest-react/packages/server

# ENTRYPOINT ["./entrypoint.sh"]

CMD ["yarn", "start:dev"]